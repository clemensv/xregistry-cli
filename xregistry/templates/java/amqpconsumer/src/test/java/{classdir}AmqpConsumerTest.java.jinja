{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "amqp.jinja.include" as amqp -%}
{%- import "util.jinja.include" as util -%}
{{ util.CommonFileHeader() }}

{%- set messagegroups = root.messagegroups %}
{%- set package_name = project_name | lower | replace('-', '_') %}
package {{ package_name }};

import org.junit.jupiter.api.*;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.containers.wait.strategy.Wait;
import org.testcontainers.utility.DockerImageName;
import org.apache.qpid.proton.Proton;
import org.apache.qpid.proton.message.Message;
import org.apache.qpid.proton.amqp.messaging.Data;
import org.apache.qpid.proton.amqp.messaging.Properties;
import org.apache.qpid.proton.amqp.messaging.ApplicationProperties;
import org.apache.qpid.proton.amqp.Binary;
import org.apache.logging.log4j.Logger;
import org.apache.logging.log4j.LogManager;

import java.net.URI;
import java.time.Duration;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Integration tests for AMQP consumer using Testcontainers with ActiveMQ Artemis
 */
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
public class AmqpConsumerTest {
    private static final Logger logger = LogManager.getLogger(AmqpConsumerTest.class);
    private static final String QUEUE_NAME = "exampleQueue";
    
    private GenericContainer<?> artemisContainer;
    private URI brokerUrl;
    
    @BeforeAll
    public void setUp() throws Exception {
        logger.info("Starting Artemis container for tests");
        
        artemisContainer = new GenericContainer<>(DockerImageName.parse("apache/activemq-artemis:latest"))
            .withExposedPorts(5672)
            .withEnv("ARTEMIS_USER", "guest")
            .withEnv("ARTEMIS_PASSWORD", "guest")
            .withEnv("ANONYMOUS_LOGIN", "true")
            .waitingFor(Wait.forListeningPort().withStartupTimeout(Duration.ofSeconds(60)));
        
        artemisContainer.start();
        
        String host = artemisContainer.getHost();
        Integer port = artemisContainer.getMappedPort(5672);
        brokerUrl = new URI("amqp://" + host + ":" + port + "/" + QUEUE_NAME);
        
        logger.info("Artemis broker URL: " + brokerUrl);
    }
    
    @AfterAll
    public void tearDown() {
        if (artemisContainer != null) {
            logger.info("Stopping Artemis container");
            artemisContainer.stop();
        }
    }
    
    {%- for messagegroupid, messagegroup in messagegroups.items() %}
    {%- set pascal_group_name = messagegroupid | pascal %}
    {%- set class_name = (pascal_group_name | strip_namespace) + "EventConsumer" %}
    
    {%- for messageid, message in messagegroup.messages.items() %}
    {%- set messagename = messageid | pascal | strip_namespace %}
    {%- set message_body_type = util.get_data_type(data_project_name, root, message) %}
    
    @Test
    @DisplayName("Test {{ messagename }} message reception")
    public void test{{ messagename }}Message() throws Exception {
        logger.info("Starting test{{ messagename }}Message");
        
        PlainEndpointCredential credential = new PlainEndpointCredential("guest", "guest");
        {{ class_name }} consumer = {{ class_name }}.createConsumer(
            credential,
            new HashMap<>(),
            List.of(brokerUrl)
        );
        
        CompletableFuture<Boolean> messageReceived = new CompletableFuture<>();
        
        consumer.on{{ messagename }}((cloudEvent, data) -> {
            try {
                logger.info("{{ messagename }} message received");
                assertNotNull(cloudEvent, "CloudEvent should not be null");
                assertNotNull(data, "Message data should not be null");
                messageReceived.complete(true);
            } catch (AssertionError ex) {
                logger.error("Assertion failed during message processing", ex);
                messageReceived.completeExceptionally(ex);
            }
        });
        
        consumer.start();
        
        try {
            // Send test message using Proton-J
            org.apache.qpid.proton.reactor.Reactor reactor = Proton.reactor();
            org.apache.qpid.proton.engine.Connection connection = reactor.connection();
            connection.setHostname(brokerUrl.getHost() + ":" + brokerUrl.getPort());
            connection.setContainer("test-sender");
            connection.setUser("guest");
            connection.setPassword("guest");
            connection.open();
            
            org.apache.qpid.proton.engine.Session session = connection.session();
            session.open();
            
            org.apache.qpid.proton.engine.Sender sender = session.sender("test-sender-link");
            sender.setTarget(Proton.terminus());
            sender.getTarget().setAddress(QUEUE_NAME);
            sender.open();
            
            // Create test message
            {%- if message_body_type != "byte[]" %}
            // Create test data instance
            {{ message_body_type }} testData = new {{ message_body_type }}();
            // TODO: Initialize testData fields
            byte[] eventData = new com.fasterxml.jackson.databind.ObjectMapper()
                .writeValueAsBytes(testData);
            {%- else %}
            byte[] eventData = "Test".getBytes();
            {%- endif %}
            
            Message testMessage = Proton.message();
            testMessage.setBody(new Data(new Binary(eventData)));
            
            Properties props = new Properties();
            props.setMessageId(UUID.randomUUID().toString());
            props.setContentType(org.apache.qpid.proton.amqp.Symbol.valueOf("application/json"));
            testMessage.setProperties(props);
            
            // Add CloudEvents attributes as application properties
            ApplicationProperties appProps = new ApplicationProperties(new HashMap<>());
            appProps.getValue().put("cloudEvents:specversion", "1.0");
            appProps.getValue().put("cloudEvents:type", "{{ messageid }}");
            appProps.getValue().put("cloudEvents:id", UUID.randomUUID().toString());
            appProps.getValue().put("cloudEvents:source", "urn:example-com:test-source");
            appProps.getValue().put("cloudEvents:time", java.time.Instant.now().toString());
            testMessage.setApplicationProperties(appProps);
            
            // Encode and send
            byte[] encoded = new byte[1024];
            int length = testMessage.encode(encoded, 0, encoded.length);
            sender.send(encoded, 0, length);
            
            // Wait for message to be received
            Boolean result = messageReceived.get(10, TimeUnit.SECONDS);
            assertTrue(result, "Message should be received and processed successfully");
            
            logger.info("Message received validation completed");
            
            sender.close();
            session.close();
            connection.close();
        } finally {
            consumer.stop();
        }
    }
    
    {%- endfor %}
    {%- endfor %}
}
