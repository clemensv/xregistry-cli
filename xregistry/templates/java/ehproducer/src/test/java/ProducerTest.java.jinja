{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "amqp.jinja.include" as amqp -%}
{%- import "util.jinja.include" as util -%}
{{ util.CommonFileHeader() }}

{%- set messagegroups = root.messagegroups %}
{%- set package_name = project_name | lower | replace('-', '_') | replace('.', '_') %}

package {{ package_name }};

import com.azure.messaging.eventhubs.EventHubProducerClient;
import com.azure.messaging.eventhubs.EventHubClientBuilder;
import com.azure.storage.blob.BlobContainerClient;
import com.azure.storage.blob.BlobServiceClient;
import com.azure.storage.blob.BlobServiceClientBuilder;
import org.junit.jupiter.api.*;
import org.apache.logging.log4j.Logger;
import org.apache.logging.log4j.LogManager;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.containers.Network;
import org.testcontainers.containers.wait.strategy.Wait;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.utility.MountableFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.time.Duration;

{%- for messagegroupid, messagegroup in messagegroups.items() %}
{%- set groupname = messagegroupid | pascal | strip_namespace %}
{%- set group_package = (package_name ~ "." ~ messagegroupid) | lower | replace('-', '_') %}
import {{ group_package }}.{{ groupname }}Producer;
{%- endfor %}

import static org.junit.jupiter.api.Assertions.*;

/**
 * Integration tests for Event Hubs producer using Testcontainers.
 * 
 * This test uses the Azure Event Hubs Emulator and Azurite containers to run integration tests
 * without requiring actual Azure resources.
 */
@Testcontainers
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
public class ProducerTest {
    
    private static final Logger logger = LogManager.getLogger(ProducerTest.class);
    
    private Network network;
    private GenericContainer<?> azuriteContainer;
    private GenericContainer<?> eventHubsEmulatorContainer;
    private Path emulatorConfigPath;
    
    private String eventHubConnectionString;
    private String blobStorageConnectionString;
    
    private static final String EMULATOR_CONFIG = """
        {
          "UserConfig": {
            "NamespaceConfig": [
              {
                "Type": "EventHub",
                "Name": "emulatorNs1",
                "Entities": [
                  {
                    "Name": "eh1",
                    "PartitionCount": "2",
                    "ConsumerGroups": [
                      {
                        "Name": "cg1"
                      }
                    ]
                  }
                ]
              }
            ],
            "LoggingConfig": {
              "Type": "File"
            }
          }
        }
        """;
    
    @BeforeAll
    public void setUp() throws IOException {
        logger.info("Setting up Event Hubs emulator testcontainers");
        
        // Create network for containers to communicate
        network = Network.newNetwork();
        
        // Create temporary config file for Event Hubs emulator
        emulatorConfigPath = Files.createTempFile("emulator-config", ".json");
        Files.writeString(emulatorConfigPath, EMULATOR_CONFIG);
        
        // Start Azurite container (blob+table storage for Event Hubs checkpoints and metadata)
        azuriteContainer = new GenericContainer<>("mcr.microsoft.com/azure-storage/azurite:latest")
            .withNetwork(network)
            .withNetworkAliases("azurite")
            .withExposedPorts(10000, 10001, 10002)
            .waitingFor(Wait.forListeningPorts(10000, 10001, 10002)
                .withStartupTimeout(Duration.ofMinutes(2)));
        
        azuriteContainer.start();
        
        // Build Azurite connection string
        blobStorageConnectionString = String.format(
            "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://%s:%d/devstoreaccount1;",
            azuriteContainer.getHost(),
            azuriteContainer.getMappedPort(10000)
        );
        
        logger.info("Azurite started at: {}", blobStorageConnectionString);
        
        // Start Event Hubs emulator container
        eventHubsEmulatorContainer = new GenericContainer<>("mcr.microsoft.com/azure-messaging/eventhubs-emulator:latest")
            .withCopyFileToContainer(MountableFile.forHostPath(emulatorConfigPath), "/Eventhubs_Emulator/ConfigFiles/Config.json")
            .withNetwork(network)
            .withNetworkAliases("eventhubs-emulator")
            .withExposedPorts(5672)
            .withEnv("BLOB_SERVER", "azurite")
            .withEnv("METADATA_SERVER", "azurite")
            .withEnv("ACCEPT_EULA", "Y")
            .waitingFor(Wait.forLogMessage(".*Emulator is launching with config.*", 1)
                .withStartupTimeout(Duration.ofMinutes(3)));
        
        eventHubsEmulatorContainer.start();
        
        // Build Event Hubs connection string
        eventHubConnectionString = "Endpoint=sb://localhost;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;EntityPath=eh1;";
        
        logger.info("Event Hubs emulator started successfully");
        
        // Create blob container for checkpoints
        try {
            BlobServiceClient blobServiceClient = new BlobServiceClientBuilder()
                .connectionString(blobStorageConnectionString)
                .buildClient();
            
            BlobContainerClient containerClient = blobServiceClient.createBlobContainerIfNotExists("eventhub-checkpoints");
            logger.info("Blob container created: {}", containerClient.getBlobContainerName());
        } catch (Exception e) {
            logger.error("Failed to create blob container", e);
            throw e;
        }
    }
    
    @AfterAll
    public void tearDown() {
        logger.info("Tearing down Event Hubs emulator testcontainers");
        
        if (eventHubsEmulatorContainer != null) {
            eventHubsEmulatorContainer.stop();
        }
        
        if (azuriteContainer != null) {
            azuriteContainer.stop();
        }
        
        if (network != null) {
            network.close();
        }
        
        if (emulatorConfigPath != null) {
            try {
                Files.deleteIfExists(emulatorConfigPath);
            } catch (IOException e) {
                logger.warn("Failed to delete emulator config file", e);
            }
        }
    }

    {%- for messagegroupid, messagegroup in messagegroups.items() %}
    {%- set groupname = messagegroupid | pascal | strip_namespace %}
    
    @Test
    @DisplayName("Test {{ groupname }}Producer with Event Hubs Emulator")
    public void test{{ groupname }}ProducerWithEmulator() {
        logger.info("Testing {{ groupname }}Producer with Event Hubs emulator");
        
        EventHubProducerClient client = new EventHubClientBuilder()
            .connectionString(eventHubConnectionString)
            .buildProducerClient();
        
        {{ groupname }}Producer producer = new {{ groupname }}Producer(client);
        assertNotNull(producer, "Producer should be created successfully");
        
        logger.info("{{ groupname }}Producer created successfully with emulator");
        
        // TODO: Add message sending tests here when message types are available
        
        try {
            producer.close();
        } catch (Exception e) {
            logger.error("Error closing producer", e);
            fail("Failed to close producer: " + e.getMessage());
        }
    }
    {%- endfor %}
}
