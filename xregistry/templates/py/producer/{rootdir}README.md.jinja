{%- import "util.include.jinja" as util -%}
{%- set messagegroups = root.messagegroups %}
{%- filter wordwrap(120) %}
# {{ project_name | capitalize }} Generic Event Producer

This module provides a generic event producer for sending events. It's designed to work with any messaging protocol
and supports CloudEvents format.

## Overview

This is a flexible producer that can be adapted to different messaging systems. It provides strongly-typed methods for
sending your event messages and handles CloudEvents serialization.

## Installation

```bash
pip install -r requirements.txt
```

## Basic Usage

{% for messagegroupid, messagegroup in messagegroups.items() %}
{%- set class_name = (messagegroupid | pascal | strip_dots) + "Producer" %}

### {{ class_name }}

Send events for the {{ messagegroupid }} message group.

```python
from {{ project_name | snake }} import {{ class_name }}
import logging

# Set up logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Create producer
# You'll need to configure this with your specific transport
producer = {{ class_name }}(
    # Add your transport configuration here
    logger=logger
)

# Send an event
{% set first_message = messagegroup.messages.items() | first %}
{% if first_message %}
{%- set messageid, message = first_message %}
{%- set data_type = util.DeclareDataType(data_project_name, root, message) %}
from {{ data_project_name | snake }} import {{ data_type | strip_namespace }}

data = {{ data_type | strip_namespace }}(
    # Set your event properties
)

await producer.send_{{ messageid | dotunderscore | snake }}(data=data)
{% endif %}
```

## Available Events

This producer can send the following event types:

{% for messageid, message in messagegroup.messages.items() %}
{%- set data_type = util.DeclareDataType(data_project_name, root, message) %}

### {{ messageid }}

**Event Type:** `{{ messageid }}`  
**Data Class:** `{{ data_type }}`  
{% if message.description %}**Description:** {{ message.description }}{% endif %}

**Send Method:**

```python
async def send_{{ messageid | dotunderscore | snake }}(
    self,
    data: {{ data_type | strip_namespace }},
    content_type: str = "application/json"
) -> None:
```

**Example:**

```python
# Create your event data
event_data = {{ data_type | strip_namespace }}(
    # Fill in properties based on your schema
)

# Send the event
await producer.send_{{ messageid | dotunderscore | snake }}(
    data=event_data,
    content_type="application/json"
)
```

{% endfor %}
{% endfor %}

## CloudEvents Support

This producer automatically wraps your event data in CloudEvents format. CloudEvents is a specification for describing
event data in a common way, making it easier to build event-driven systems.

### What You Get

- **Automatic CloudEvents wrapping**: Your data is automatically formatted
- **Standard attributes**: `type`, `source`, `id`, `time` are set automatically
- **Flexible content types**: JSON, Avro, Protobuf supported (based on configuration)

### CloudEvents Attributes

The producer sets these CloudEvents attributes automatically:

- **id**: Unique identifier (auto-generated UUID)
- **source**: Event source (configured in your template)
- **type**: Event type (e.g., `YourMessageType`)
- **specversion**: CloudEvents specification version (1.0)
- **datacontenttype**: Content type of the data (default: `application/json`)
- **time**: Event timestamp (auto-generated)

## Error Handling

Handle errors when sending events:

```python
try:
    await producer.send_event_name(data=event_data)
except ConnectionError as e:
    logger.error(f"Failed to connect: {e}")
except TimeoutError as e:
    logger.error(f"Send timeout: {e}")
except Exception as e:
    logger.error(f"Unexpected error: {e}")
```

## Async/Await

All send methods are **asynchronous** and must be awaited:

```python
import asyncio

async def main():
    producer = {{ (messagegroups.keys() | first | pascal | strip_dots) + "Producer" }}(...)
    
    # Send events
    await producer.send_event(data)
    
    # Close producer
    await producer.close()

# Run async code
asyncio.run(main())
```

## Context Manager

Use the producer as an async context manager for automatic cleanup:

```python
async with {{ (messagegroups.keys() | first | pascal | strip_dots) + "Producer" }}(...) as producer:
    await producer.send_event(data)
    # Automatically closed when exiting context
```

## Configuration

Configure the producer based on your messaging system. Common patterns:

```python
# Example configuration (adapt to your transport)
producer = MyProducer(
    endpoint="your-endpoint",
    credentials=your_credentials,
    logger=logger
)
```

## Testing

Run the included tests:

```bash
pytest
```

Write your own tests:

```python
import pytest
from {{ project_name | snake }} import {{ (messagegroups.keys() | first | pascal | strip_dots) + "Producer" }}

@pytest.mark.asyncio
async def test_send_event():
    producer = {{ (messagegroups.keys() | first | pascal | strip_dots) + "Producer" }}(...)
    
    # Create test data
    data = YourDataClass(...)
    
    # Send should not raise
    await producer.send_your_event(data=data)
```

## Type Hints

This package includes full type hints for better IDE support and type checking:

```bash
# Check types with mypy
mypy {{ project_name | snake }}
```

## Dependencies

- **cloudevents**: CloudEvents Python SDK
- **dataclasses** or **pydantic**: For data validation (Python 3.7+)

See `requirements.txt` for full list.

## Adapting to Your Transport

This is a generic producer template. To use it with a specific messaging system:

1. **Implement transport layer**: Add connection code for your messaging system
2. **Configure endpoints**: Set up connection strings and credentials
3. **Handle serialization**: Configure how events are serialized (JSON, Avro, etc.)
4. **Add error handling**: Implement retry logic specific to your transport

## Examples

### JSON Serialization

```python
import json
from {{ project_name | snake }} import {{ (messagegroups.keys() | first | pascal | strip_dots) + "Producer" }}

# The producer automatically serializes to JSON
data = YourDataClass(field1="value1", field2="value2")
await producer.send_event(data=data, content_type="application/json")
```

### Custom Serialization

```python
# If you need custom serialization
data = YourDataClass(...)

# Serialize yourself
json_data = json.dumps(data.__dict__)

# Or use the producer's built-in serialization
await producer.send_event(data=data)
```

## Learn More

- [CloudEvents Specification](https://cloudevents.io/)
- [xRegistry CLI Documentation](https://github.com/clemensv/xregistry-cli)
- [Python async/await](https://docs.python.org/3/library/asyncio.html)

## Generated Code

This code was auto-generated by [xRegistry CLI](https://github.com/clemensv/xregistry-cli).

**Project:** {{ project_name }}  
**Type:** Generic Producer  
**Envelope:** CloudEvents 1.0

## Troubleshooting

**Import errors**: Make sure you've installed dependencies: `pip install -r requirements.txt`

**Async errors**: Ensure you're using `await` with async methods and running in an async context

**Type errors**: Run `mypy` to check type hints

**Connection errors**: Verify your transport configuration and network connectivity
{%- endfilter %}
