{%- import "util.jinja.include" as util -%}
{%- set messagegroups = root.messagegroups %}
{% for messagegroupid, messagegroup in messagegroups.items() -%}
{%- set groupname = messagegroupid | pascal -%}
{%- set class_name = (groupname | strip_namespace) + "EventConsumer" %}
# {{ project_name }} - AMQP 1.0 Consumer

Auto-generated TypeScript consumer for receiving CloudEvents via AMQP 1.0 protocol.

## Overview

This library provides a type-safe AMQP 1.0 consumer client for {{ groupname }} message group. Built on `rhea` for Node.js AMQP messaging.

## What is AMQP 1.0?

**AMQP (Advanced Message Queuing Protocol) 1.0** is an open standard for business messaging that supports:
- **Message queuing** for reliable asynchronous communication
- **Request/response** and publish/subscribe patterns
- **Message durability** with persistent storage
- **Transactions** and flow control

Common brokers: Azure Service Bus, Apache ActiveMQ Artemis, Apache Qpid, RabbitMQ.

## Installation

```bash
npm install
```

## Building

```bash
npm run build
```

## Testing

```bash
npm test
```

## Quick Start

### 1. Basic Usage

```typescript
import { AmqpConsumer, {{ class_name }} } from './src';

// Connect to AMQP broker
const consumer = new AmqpConsumer('localhost', 5672, 'test-queue', {
    username: 'guest',
    password: 'guest'
});

// Create event dispatcher
const dispatcher = new {{ class_name }}();

{%- set first_message = messagegroup.messages.items() | first %}
{%- if first_message %}
{%- set messageid, message = first_message %}
{%- set messagename = messageid | pascal | strip_namespace %}
{%- set message_body_type = util.body_type(data_project_name, root, message) %}

// Register handler for {{ messagename }}
dispatcher.{{ messagename }}Handler = async (message, data) => {
    console.log('Received {{ messagename }}:', data);
    // Process your event data here
};
{%- endif %}

// Connect dispatcher to consumer
consumer.processMessage = async (message) => {
    await dispatcher.processMessage(message);
};

// Start receiving messages
await consumer.start();

// Later: stop gracefully
await consumer.close();
```

## Available Event Handlers

{% for messageid, message in messagegroup.messages.items() -%}
{%- set messagename = messageid | pascal | strip_namespace %}
{%- set message_body_type = util.body_type(data_project_name, root, message) %}
### {{ messagename }}Handler

**Message Type:** `{{ messageid }}`
**Data Type:** `{{ message_body_type | strip_namespace }}`

```typescript
dispatcher.{{ messagename }}Handler = async (message, data: {{ message_body_type | strip_namespace }}) => {
    // Handle {{ messagename }} event
    console.log('Processing {{ messagename }}:', data);
};
```

{% if message.description -%}
{{ message.description }}
{% endif %}
{% endfor %}

## Connection Configuration

The `AmqpConsumer` constructor accepts the following parameters:

```typescript
new AmqpConsumer(
    host: string,           // AMQP broker hostname
    port: number,           // AMQP broker port (typically 5672)
    address: string,        // Queue or topic address
    options?: {
        username?: string,  // Authentication username
        password?: string,  // Authentication password
        transport?: 'tcp' | 'tls',  // Transport protocol
        reconnect?: boolean // Auto-reconnect on disconnect
    }
)
```

## Error Handling

```typescript
dispatcher.{{ messagename }}Handler = async (message, data) => {
    try {
        // Process message
        await processEvent(data);
    } catch (error) {
        console.error('Failed to process {{ messagename }}:', error);
        // Message will be rejected and may be requeued depending on broker settings
        throw error;
    }
};
```

## Best Practices

1. **Always close the consumer** when shutting down to ensure clean disconnection
2. **Handle errors in event handlers** to prevent message loss
3. **Use typed data models** from the generated types for type safety
4. **Configure reconnection** for production environments
5. **Monitor message processing** for failures and retries
{% endfor %}
