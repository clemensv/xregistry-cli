{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "util.jinja.include" as util -%}
// This code was generated by the xRegistry tool.
// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.

import { ServiceBusClient, ServiceBusReceiver } from '@azure/service-bus';
{%- set messagegroups = root.messagegroups %}
{%- set uses_cloudevents_message = cloudEvents.usesCloudEvents(root) %}

import { {% for messagegroupid, messagegroup in messagegroups.items() -%}{%- set class_name = (messagegroupid | pascal | strip_namespace) + "Producer" %}{{ class_name }}{% if not loop.last %}, {% endif %}{% endfor %} } from '../src';
{%- if uses_cloudevents_message %}
import { CloudEvent } from 'cloudevents';
{%- endif %}

const SERVICEBUS_CONNECTION_STRING = process.env.SERVICEBUS_CONNECTION_STRING || 
    'Endpoint=sb://localhost;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=XXXXX';
const QUEUE_NAME = 'test-queue';

jest.setTimeout(60000);

{%- for messagegroupid, messagegroup in messagegroups.items() %}
{%- set pascal_group_name = messagegroupid | pascal %}
{%- set class_name = (pascal_group_name | strip_namespace) + "Producer" %}
{%- set test_class_name = (project_name | strip_dots | pascal) + (pascal_group_name | strip_dots) + "Tests" %}

describe('{{ test_class_name }}', () => {
    let client: ServiceBusClient;
    let producer: {{ class_name }};
    let receiver: ServiceBusReceiver;
    
    beforeAll(async () => {
        client = new ServiceBusClient(SERVICEBUS_CONNECTION_STRING);
        producer = new {{ class_name }}(client, QUEUE_NAME);
        receiver = client.createReceiver(QUEUE_NAME);
    });
    
    afterAll(async () => {
        await producer.close();
        await receiver.close();
    });
    
    {%- set message_list = messagegroup.messages.items() | list %}
    {%- for messageid, message in message_list[:3] %}
    {%- set messagename = messageid | strip_namespace | pascal %}
    {%- set body_type = util.body_type(message) %}
    
    test('should send {{ messagename }} message', async () => {
        const testData: {{ body_type }} = {
            {%- if message.schemaurl %}
            {%- set schema = schemaobj(message.schemaurl) %}
            {%- if schema %}
            {%- if schema.type == "avro" %}
            {%- set avro_schema = schema.schema %}
            {%- for field in avro_schema.fields[:3] %}
            {{ field.name }}: {% if field.type == "string" %}'test-value-{{ loop.index }}'{% elif field.type == "int" %}{{ loop.index }}{% elif field.type == "boolean" %}true{% else %}null{% endif %},
            {%- endfor %}
            {%- elif schema.type == "json" %}
            {%- if schema.schema and schema.schema.properties %}
            {%- for propname, prop in (schema.schema.properties.items() | list)[:3] %}
            {{ propname }}: {% if prop.type == "string" %}'test-value-{{ loop.index }}'{% elif prop.type == "number" %}{{ loop.index }}{% elif prop.type == "boolean" %}true{% else %}null{% endif %},
            {%- endfor %}
            {%- endif %}
            {%- endif %}
            {%- endif %}
            {%- endif %}
        };
        
        await expect(producer.send{{ messagename }}(testData)).resolves.not.toThrow();
    });
    
    test('should send {{ messagename }} batch', async () => {
        const testData: {{ body_type }}[] = [
            {
                {%- if message.schemaurl %}
                {%- set schema = schemaobj(message.schemaurl) %}
                {%- if schema %}
                {%- if schema.type == "avro" %}
                {%- set avro_schema = schema.schema %}
                {%- for field in avro_schema.fields[:3] %}
                {{ field.name }}: {% if field.type == "string" %}'batch-1-{{ loop.index }}'{% elif field.type == "int" %}{{ loop.index }}{% elif field.type == "boolean" %}true{% else %}null{% endif %},
                {%- endfor %}
                {%- elif schema.type == "json" %}
                {%- if schema.schema and schema.schema.properties %}
                {%- for propname, prop in (schema.schema.properties.items() | list)[:3] %}
                {{ propname }}: {% if prop.type == "string" %}'batch-1-{{ loop.index }}'{% elif prop.type == "number" %}{{ loop.index }}{% elif prop.type == "boolean" %}true{% else %}null{% endif %},
                {%- endfor %}
                {%- endif %}
                {%- endif %}
                {%- endif %}
                {%- endif %}
            },
            {
                {%- if message.schemaurl %}
                {%- set schema = schemaobj(message.schemaurl) %}
                {%- if schema %}
                {%- if schema.type == "avro" %}
                {%- set avro_schema = schema.schema %}
                {%- for field in avro_schema.fields[:3] %}
                {{ field.name }}: {% if field.type == "string" %}'batch-2-{{ loop.index }}'{% elif field.type == "int" %}{{ loop.index * 2 }}{% elif field.type == "boolean" %}false{% else %}null{% endif %},
                {%- endfor %}
                {%- elif schema.type == "json" %}
                {%- if schema.schema and schema.schema.properties %}
                {%- for propname, prop in (schema.schema.properties.items() | list)[:3] %}
                {{ propname }}: {% if prop.type == "string" %}'batch-2-{{ loop.index }}'{% elif prop.type == "number" %}{{ loop.index * 2 }}{% elif prop.type == "boolean" %}false{% else %}null{% endif %},
                {%- endfor %}
                {%- endif %}
                {%- endif %}
                {%- endif %}
                {%- endif %}
            }
        ];
        
        await expect(producer.send{{ messagename }}Batch(testData)).resolves.not.toThrow();
    });
    {%- endfor %}
});
{%- endfor %}
