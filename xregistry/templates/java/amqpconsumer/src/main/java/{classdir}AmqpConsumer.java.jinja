{%- import "util.jinja.include" as util -%}
{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "amqp.jinja.include" as amqp -%}
{{ util.CommonFileHeader() }}

package {{ project_name | lower | replace('-', '_') }};

import org.apache.qpid.proton.Proton;
import org.apache.qpid.proton.reactor.Reactor;
import org.apache.qpid.proton.reactor.ReactorOptions;
import org.apache.qpid.proton.message.Message;
import org.apache.qpid.proton.engine.*;
import org.apache.qpid.proton.engine.impl.ReceiverImpl;
import org.apache.qpid.proton.reactor.impl.IOHandler;
import org.apache.logging.log4j.Logger;
import org.apache.logging.log4j.LogManager;

import java.net.URI;
import java.util.List;
import java.util.Map;
import java.util.function.BiConsumer;
import java.util.concurrent.atomic.AtomicBoolean;

{{ util.EndpointCredentialClasses() }}

/**
 * AMQP 1.0 consumer using Apache Qpid Proton-J
 */
class AmqpConsumer extends BaseHandler {
    private static final Logger logger = LogManager.getLogger(AmqpConsumer.class);
    private final EndpointCredential credential;
    private final List<URI> endpoints;
    private final String node;
    private final BiConsumer<Message, Logger> messageHandler;
    private final AtomicBoolean running = new AtomicBoolean(false);
    private Reactor reactor;
    
    public AmqpConsumer(
        EndpointCredential credential,
        Map<String, String> options,
        List<URI> endpoints,
        BiConsumer<Message, Logger> messageHandler
    ) {
        this.credential = credential;
        this.endpoints = endpoints;
        this.node = options.getOrDefault("node", null);
        this.messageHandler = messageHandler;
        add(new IOHandler());
    }
    
    /**
     * Start the consumer
     */
    public void start() throws Exception {
        if (running.compareAndSet(false, true)) {
            ReactorOptions reactorOptions = new ReactorOptions();
            reactor = Proton.reactor(reactorOptions, this);
            
            // Create connections for all endpoints
            for (URI endpoint : endpoints) {
                createConnection(endpoint);
            }
            
            // Run reactor in background thread
            Thread reactorThread = new Thread(() -> {
                try {
                    reactor.run();
                } catch (Exception ex) {
                    logger.error("Reactor error: " + ex.getMessage(), ex);
                }
            });
            reactorThread.setDaemon(true);
            reactorThread.start();
        }
    }
    
    /**
     * Stop the consumer
     */
    public void stop() {
        if (running.compareAndSet(true, false)) {
            if (reactor != null) {
                reactor.stop();
                reactor.free();
            }
        }
    }
    
    private void createConnection(URI endpoint) {
        String host = endpoint.getHost();
        int port = endpoint.getPort() == -1 ?
            (endpoint.getScheme().equalsIgnoreCase("amqps") ? 5671 : 5672) :
            endpoint.getPort();
        String path = node != null ? node : endpoint.getPath();
        
        Connection connection = reactor.connection();
        connection.setHostname(host + ":" + port);
        connection.setContainer("amqp-consumer-" + System.currentTimeMillis());
        
        // Configure authentication
        if (credential instanceof PlainEndpointCredential) {
            PlainEndpointCredential plain = (PlainEndpointCredential) credential;
            connection.setUser(plain.getClientId());
            connection.setPassword(plain.getClientSecret());
        }
        
        connection.open();
        
        Session session = connection.session();
        session.open();
        
        Receiver receiver = session.receiver("receiver-link");
        if (path != null && !path.isEmpty()) {
            receiver.setSource(Proton.terminus());
            receiver.getSource().setAddress(path);
        }
        receiver.open();
    }
    
    @Override
    public void onDelivery(Event event) {
        Receiver receiver = (Receiver) event.getLink();
        Delivery delivery = receiver.current();
        
        if (delivery != null && delivery.isReadable() && !delivery.isPartial()) {
            byte[] data = new byte[delivery.pending()];
            int read = receiver.recv(data, 0, data.length);
            
            try {
                Message message = Proton.message();
                message.decode(data, 0, read);
                
                // Dispatch message
                messageHandler.accept(message, logger);
                
                // Accept the message
                delivery.disposition(Accepted.getInstance());
                delivery.settle();
            } catch (Exception ex) {
                logger.error("Error processing message: " + ex.getMessage(), ex);
                delivery.disposition(new Rejected());
                delivery.settle();
            }
            
            receiver.advance();
        }
    }
}
