{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "util.jinja.include" as util -%}
// This code was generated by the xRegistry tool.
// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.

import * as rhea from 'rhea';
{%- set messagegroups = root.messagegroups %}
{%- set uses_cloudevents_message = cloudEvents.usesCloudEvents(root) %}

import { AmqpConsumer, {% for messagegroupid, messagegroup in messagegroups.items() -%}{%- set class_name = (messagegroupid | pascal | strip_namespace) + "EventConsumer" %}{{ class_name }}{% if not loop.last %}, {% endif %}{% endfor %} } from '../src';
{%- if uses_cloudevents_message %}
import { CloudEvent } from 'cloudevents';
{%- endif %}

const AMQP_HOST = process.env.AMQP_HOST || 'localhost';
const AMQP_PORT = parseInt(process.env.AMQP_PORT || '5672');
const AMQP_ADDRESS = 'test-queue';

jest.setTimeout(60000);

{%- for messagegroupid, messagegroup in messagegroups.items() %}
{%- set pascal_group_name = messagegroupid | pascal %}
{%- set class_name = (pascal_group_name | strip_namespace) + "EventConsumer" %}
{%- set test_class_name = (project_name | strip_dots | pascal) + (pascal_group_name | strip_dots) + "Tests" %}

describe('{{ test_class_name }}', () => {
    let consumer: AmqpConsumer;
    let sender: rhea.Sender | null = null;
    
    beforeAll(async () => {
        consumer = new AmqpConsumer(AMQP_HOST, AMQP_PORT, AMQP_ADDRESS);
        
        // Create sender for testing
        const container = rhea.create_container();
        const connection = container.connect({ host: AMQP_HOST, port: AMQP_PORT });
        sender = connection.open_sender({ target: { address: AMQP_ADDRESS } });
    });
    
    afterAll(async () => {
        await consumer.stop();
        if (sender) {
            sender.close();
        }
    });
    
    {%- set message_list = messagegroup.messages.items() | list %}
    {%- for messageid, message in message_list[:3] %}
    {%- set messagename = messageid | strip_namespace | pascal %}
    {%- set body_type = util.body_type(message) %}
    
    test('should dispatch {{ messagename }} message', async () => {
        const dispatcher = new {{ class_name }}();
        
        const receivedMessages: {{ body_type }}[] = [];
        
        dispatcher.{{ messagename }}Handler = async (message: rhea.Message, data: {{ body_type }}) => {
            receivedMessages.push(data);
        };
        
        consumer.processMessage = async (message: rhea.Message) => {
            await dispatcher.processMessage(message);
        };
        
        // Send test message
        const testData: {{ body_type }} = {
            {%- if message.schemaurl %}
            {%- set schema = schemaobj(message.schemaurl) %}
            {%- if schema %}
            {%- if schema.type == "avro" %}
            {%- set avro_schema = schema.schema %}
            {%- for field in avro_schema.fields[:3] %}
            {{ field.name }}: {% if field.type == "string" %}'test-value'{% elif field.type == "int" %}42{% elif field.type == "boolean" %}true{% else %}null{% endif %},
            {%- endfor %}
            {%- elif schema.type == "json" %}
            {%- if schema.schema and schema.schema.properties %}
            {%- for propname, prop in (schema.schema.properties.items() | list)[:3] %}
            {{ propname }}: {% if prop.type == "string" %}'test-value'{% elif prop.type == "number" %}42{% elif prop.type == "boolean" %}true{% else %}null{% endif %},
            {%- endfor %}
            {%- endif %}
            {%- endif %}
            {%- endif %}
            {%- endif %}
        };
        
        {%- if uses_cloudevents_message %}
        const cloudEvent = new CloudEvent({
            type: '{{ messageid }}',
            source: '/test',
            data: testData,
            datacontenttype: 'application/json'
        });
        
        sender!.send({
            body: cloudEvent.toJSON(),
            content_type: 'application/cloudevents+json'
        });
        {%- else %}
        sender!.send({
            body: testData,
            application_properties: {
                subject: '{{ messageid }}'
            }
        });
        {%- endif %}
        
        // Start processing
        await consumer.start();
        
        // Wait for message to be processed
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        await consumer.stop();
        
        expect(receivedMessages.length).toBeGreaterThan(0);
        {%- if message.schemaurl %}
        {%- set schema = schemaobj(message.schemaurl) %}
        {%- if schema %}
        {%- if schema.type == "avro" %}
        {%- set avro_schema = schema.schema %}
        {%- for field in avro_schema.fields[:1] %}
        expect(receivedMessages[0].{{ field.name }}).toBeDefined();
        {%- endfor %}
        {%- elif schema.type == "json" %}
        {%- if schema.schema and schema.schema.properties %}
        {%- for propname in (schema.schema.properties.keys() | list)[:1] %}
        expect(receivedMessages[0].{{ propname }}).toBeDefined();
        {%- endfor %}
        {%- endif %}
        {%- endif %}
        {%- endif %}
        {%- endif %}
    });
    {%- endfor %}
});
{%- endfor %}
